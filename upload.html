<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Your Bill – BillSwap</title>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f3f4f6;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 0.5rem;
    }
    p {
      font-size: 0.95rem;
      color: #4b5563;
    }
    input[type="file"] {
      margin: 1.25rem 0;
      font-size: 0.9rem;
    }
    button {
      background-color: #5b2eff;
      color: white;
      padding: 0.75rem 1.25rem;
      font-size: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    #resultBox {
      display: none;
      text-align: left;
      margin-top: 2rem;
    }
    .offer {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 0.75rem;
      border-radius: 10px;
      margin-top: 1rem;
    }
    .offer button {
      background: none;
      color: #5b2eff;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Upload Your Bill</h2>
    <p>Take a photo or upload a PDF. We'll analyze it and show you better deals.</p>

    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" id="file" name="file" accept="image/*,.pdf" capture="environment" required /><br />
      <button type="submit">Upload & Analyze</button>
    </form>

    <div id="resultBox">
      <h3>Bill Summary</h3>
      <p><strong>Provider:</strong> <span id="provider"></span></p>
      <p><strong>Monthly Cost:</strong> <span id="cost"></span></p>
      <p><strong>Speed:</strong> <span id="speed"></span></p>
      <div id="offersContainer"></div>
    </div>
  </div>

  <script>
    let currentUID = null;

    window.onload = function () {
      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          currentUID = user.uid;
          console.log("Logged in UID:", currentUID);
        } else {
          alert("Please log in to continue");
        }
      });
    };

    function openFlutterComparison(offer, currentBill) {
      let baseURL;
      try {
        const referrer = document.referrer;
        const parsedRef = new URL(referrer);
        baseURL = parsedRef.hostname.includes("flutterflow.io") ? parsedRef.origin : null;
      } catch (err) {
        alert("This feature only works within the app.");
        return;
      }

      const comparisonPath = "/#/comparisonpage";
      const params = new URLSearchParams({
        planTitle: offer.title || "N/A",
        planPrice: offer.price?.toFixed(2) || "N/A",
        planProvider: offer.provider || "N/A",
        planSpeed: offer.min_speed || "N/A",
        planLink: offer.affiliatelink || "#",
        type: "comparison",
        currentProvider: currentBill?.provider || "N/A",
        currentCost: currentBill?.monthly_cost?.toFixed(2) || "N/A",
        currentSpeed: currentBill?.speed_mbps || "N/A",
      });

      window.parent.location.href = `${baseURL}${comparisonPath}?${params.toString()}`;
    }

    const API_ENDPOINT = "https://billswap-proxy.jsbenoit.workers.dev";

    document.getElementById("uploadForm").addEventListener("submit", async function (event) {
      event.preventDefault();

      const file = document.getElementById("file").files[0];
      const resultBox = document.getElementById("resultBox");
      const offersContainer = document.getElementById("offersContainer");
      resultBox.style.display = "none";
      offersContainer.innerHTML = "";

      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64Image = reader.result.split(",")[1];
          const payload = {
            image_base64: base64Image,
            user_id: currentUID,
          };

          const response = await fetch(API_ENDPOINT + "/analyze-bill", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          displayResults(result);
        };
        reader.readAsDataURL(file);
      } else {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("user_id", currentUID);

        const response = await fetch(API_ENDPOINT + "/analyze-bill", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        displayResults(result);
      }
    });

    function displayResults(result) {
      const resultBox = document.getElementById("resultBox");
      const offersContainer = document.getElementById("offersContainer");
      const bill = result.bill || {};
      const offers = result.offers || [];

      document.getElementById("provider").textContent = bill.provider ?? "N/A";
      document.getElementById("cost").textContent = bill.monthly_cost != null ? `$${bill.monthly_cost.toFixed(2)}` : "N/A";
      document.getElementById("speed").textContent = bill.speed_mbps ? `${bill.speed_mbps} Mbps` : "N/A";
      resultBox.style.display = "block";

      if (offers.length > 0) {
        offers.forEach((offer, index) => {
          const html = `
            <div class="offer">
              <strong>${offer.provider || "Provider N/A"}</strong><br>
              ${offer.price ? `$${offer.price.toFixed(2)}` : ""} – ${offer.min_speed ? `${offer.min_speed} Mbps` : ""}<br>
              <button data-index="${index}" class="view-deal-btn">View Deal</button>
            </div>
          `;
          offersContainer.innerHTML += html;
        });

        window.currentBill = bill;
        window.offers = offers;

        document.querySelectorAll(".view-deal-btn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const index = parseInt(e.target.getAttribute("data-index"));
            openFlutterComparison(window.offers[index], window.currentBill);
          });
        });
      } else {
        offersContainer.innerHTML = `<p>No cheaper offers found.</p>`;
      }
    }
  </script>
</body>
</html>
